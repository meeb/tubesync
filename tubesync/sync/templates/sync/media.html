{% extends 'base.html' %}{% load static %}

{% block headtitle %}Media{% if source %} - {{ source }}{% endif %}{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
  <h1 class="truncate flex-1 !pb-0">Media</h1>
  <div class="flex flex-wrap gap-2">
    {% if show_skipped %}
    <a href="{% url 'sync:media' %}{% querystring show_skipped=None %}" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-border bg-card text-sm font-medium hover:bg-muted transition-colors"><i class="far fa-eye-slash"></i> Hide skipped</a>
    {% else %}
    <a href="{% url 'sync:media' %}{% querystring show_skipped='yes' %}" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-border bg-card text-sm font-medium hover:bg-muted transition-colors"><i class="far fa-eye"></i> Show skipped</a>
    {% endif %}
    {% if only_skipped %}
    <a href="{% url 'sync:media' %}{% querystring only_skipped=None %}" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-border bg-card text-sm font-medium hover:bg-muted transition-colors"><i class="far fa-eye-slash"></i> Only skipped</a>
    {% else %}
    <a href="{% url 'sync:media' %}{% querystring only_skipped='yes' %}" class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-border bg-card text-sm font-medium hover:bg-muted transition-colors"><i class="far fa-eye"></i> Only skipped</a>
    {% endif %}
  </div>
</div>

<!-- Search -->
<div class="rounded-lg border border-border bg-muted/30 p-4 mb-6">
  <form method="get" class="flex flex-col sm:flex-row gap-3 items-end">
    {% if only_skipped %}<input type="hidden" name="only_skipped" value="yes" />{% endif %}
    {% if show_skipped %}<input type="hidden" name="show_skipped" value="yes" />{% endif %}
    <div class="flex-1">
      <label class="block text-sm font-medium mb-1.5">Search for:</label>
      <input name="query" type="text" placeholder="A key or title containing this text"{% if query %} value="{{ query }}"{% endif %} class="w-full px-3 py-2 rounded-md border border-input bg-background text-sm" />
    </div>
    <div class="flex items-center gap-3">
      <label class="flex items-center gap-2 cursor-pointer text-sm">
        <input name="search_description" type="checkbox" value="yes" {% if search_description %}checked {% endif %}/>
        <span>In description?</span>
      </label>
      <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-primary text-primary-foreground font-medium text-sm hover:bg-accent hover:text-accent-foreground transition-colors">Go</button>
    </div>
  </form>
</div>

{% include 'infobox.html' with message=message %}

<!-- Media grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
  {% for m in media %}
  <a href="{% url 'sync:media-item' pk=m.pk %}" title="{{ m.source.name }} / {{ m.name }}" class="group rounded-lg border border-border overflow-hidden bg-card hover:border-accent transition-colors">
    <div class="relative aspect-video bg-muted">
      <img src="{% if m.thumb %}{% url 'sync:media-thumb' pk=m.pk %}{% else %}{% static 'images/nothumb.png' %}{% endif %}" class="w-full h-full object-cover" loading="lazy">
      <div class="absolute bottom-0 right-0 m-1.5 px-2 py-1 bg-nav/90 text-nav-foreground text-xs rounded max-w-[80%]">
        <div class="truncate font-medium">{{ m.source }}</div>
      </div>
    </div>
    <div class="p-3">
      <div class="truncate text-sm font-medium text-foreground">{{ m.name }}</div>
      <div class="text-xs mt-1">
        {% if m.downloaded %}
          <span class="text-green-600"><i class="fas fa-check-circle" title="Downloaded"></i> {{ m.download_date|date:'Y-m-d' }}</span>
        {% else %}
          {% if m.manual_skip %}
          <span class="text-destructive"><i class="fas fa-times" title="Skipping media"></i> Manually skipped</span>
          {% elif m.skip %}
          <span class="text-destructive"><i class="fas fa-times" title="Skipping media"></i> Skipped by system</span>
          {% elif not m.source.download_media %}
          <span class="text-destructive"><i class="fas fa-times" title="Not downloading media"></i> Disabled at source</span>
          {% elif not m.has_metadata %}
          <span class="text-muted-foreground"><i class="far fa-clock" title="Waiting for metadata"></i> Fetching metadata</span>
          {% elif m.can_download %}
          <span class="text-primary"><i class="far fa-clock" title="Downloading"></i> Downloading</span>
          {% else %}
          <span class="text-destructive"><i class="fas fa-exclamation-triangle" title="No matching formats"></i> No matching formats</span>
          {% endif %}
        {% endif %}
      </div>
    </div>
  </a>
  {% empty %}
  <div class="col-span-full p-4 rounded-lg border border-border text-muted-foreground">
    <i class="fas fa-info-circle"></i> No media has been indexed{% if source %} that matches the specified source filter{% endif %}.
  </div>
  {% endfor %}
</div>

{% include 'pagination.html' %}
{% endblock %}
