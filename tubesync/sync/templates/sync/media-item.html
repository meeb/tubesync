{% extends 'base.html' %}{% load static %}{% load humanize %}{% load filters %}

{% block headtitle %}Media - {{ media.key }}{% endblock %}

{% block content %}
<h1 class="truncate">Media <strong>{{ media.key }}</strong> {{ download_state_icon|safe }}</h1>
{% if media.title %}<h2 class="truncate !pt-0"><strong>{{ media.title }}</strong></h2>{% endif %}
<p class="truncate mb-1"><strong><a href="{{ media.url }}" target="_blank"><i class="fas fa-link"></i> {{ media.url }}</a></strong></p>
<p class="truncate text-muted-foreground mb-4">Downloading to: <strong class="text-foreground">{{ media.source.directory_path }}</strong></p>

{% if download_state == 'downloaded' %}
<div class="mb-6">
  {% if media.source.is_audio %}
  <audio controls src="{% url 'sync:media-content' pk=media.pk %}" class="w-full rounded-lg"></audio>
  {% else %}
  <video controls class="w-full rounded-lg bg-black">
    <source src="{% url 'sync:media-content' pk=media.pk %}">
  </video>
  {% endif %}
  <p class="mt-2"><a href="{% url 'sync:media-content' pk=media.pk %}" download="{{ media.filename }}"><strong><i class="fas fa-download"></i> Download</strong></a></p>
</div>
{% elif media.can_download %}
<p class="mb-4"><a href="{% url 'sync:redownload-media' pk=media.pk %}{% querystring manual=True %}"><strong><i class="fas fa-download"></i> Begin Downloading</strong></a> (please be patient)</p>
{% endif %}

{% if media.manual_skip %}{% include 'errorbox.html' with message='Media is marked to be skipped and will not be downloaded.' %}
{% else %}
  {% if not media.can_download %}{% include 'errorbox.html' with message='Media cannot be downloaded because it has no formats which match the source requirements.' %}{% endif %}
  {% if media.skip %}{% include 'errorbox.html' with message='This media may be skipped due to error(s) or not matching a filter condition.' %}{% endif %}
{% endif %}
{% include 'infobox.html' with message=message %}

<!-- Description + Thumbnail -->
<div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-6">
  <div class="md:col-span-7">
    <div class="text-muted-foreground mb-2"><i class="fas fa-quote-left"></i></div>
    <p class="text-sm leading-relaxed">{% if media.description %}{{ media.description|truncatewords:200 }}{% else %}(Media has no description).{% endif %}</p>
    <div class="text-right text-muted-foreground mt-2"><i class="fas fa-quote-right"></i></div>
  </div>
  <div class="md:col-span-5">
    <div class="rounded-lg border border-border overflow-hidden bg-card">
      <img src="{% if media.thumb %}{% url 'sync:media-thumb' pk=media.pk %}{% else %}{% static 'images/nothumb.png' %}{% endif %}" class="w-full">
      <div class="px-3 py-2 text-sm">
        <a href="{% url 'sync:redownload-thumb' pk=media.pk %}" class="text-muted-foreground hover:text-primary"><i class="fas fa-redo"></i> Re-fetch thumbnail</a>
      </div>
    </div>
  </div>
</div>

{% if task %}
<div class="rounded-lg border border-border p-4 mb-6">
  {% if task.start_at == task.end_at %}
  <i class="fas fa-running text-accent"></i> <strong>{{ task }}</strong><br>
  <span class="text-sm text-muted-foreground"><i class="far fa-clock"></i> Task started at <strong class="text-foreground">{{ task.start_at|date:'Y-m-d H:i:s' }}</strong></span>
  {% else %}
  <i class="fas fa-stopwatch text-primary"></i> <strong>{{ task }}</strong><br>
  <span class="text-sm text-muted-foreground"><i class="fas fa-redo"></i> Task will run {% if task.run_now %}<strong class="text-foreground">immediately</strong>{% else %}at <strong class="text-foreground">{{ task.scheduled_at|date:'Y-m-d H:i:s' }}</strong>{% endif %}</span>
  {% endif %}
</div>
{% endif %}

<!-- Details table -->
<div class="rounded-lg border border-border overflow-hidden mb-6">
  <table class="w-full text-sm">
    <tr title="The media source" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Source</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Source<br></span><strong><a href="{% url 'sync:source' pk=media.source.pk %}">{{ media.source }}</a></strong></td>
    </tr>
    <tr title="The media duration" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Duration</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Duration<br></span><strong>{{ media.duration_formatted }}</strong></td>
    </tr>
    <tr title="The media publication date" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Published</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Published<br></span><strong>{{ media.published|date:'Y-m-d H:i' }}</strong></td>
    </tr>
    <tr title="The desired format" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Desired format</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Desired format<br></span><strong>{{ media.source.format_summary }}</strong></td>
    </tr>
    <tr title="Fallback" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Fallback</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Fallback<br></span><strong>{{ media.source.get_fallback_display }}</strong></td>
    </tr>
    <tr title="The media title" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Title</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Title<br></span><strong>{{ media.title }}</strong></td>
    </tr>
    {% if not media.source.download_media %}
    <tr title="Source download?" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Source download?</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Source download?<br></span><strong>{% if media.source.download_media %}<i class="fas fa-check text-green-600"></i>{% else %}<i class="fas fa-times text-destructive"></i>{% endif %}</strong></td>
    </tr>
    {% endif %}
    {% if media.skip %}
    <tr title="Skipping?" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Skipping?</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Skipping?<br></span><strong>{% if media.skip %}<i class="fas fa-check text-green-600"></i>{% else %}<i class="fas fa-times text-destructive"></i>{% endif %}</strong></td>
    </tr>
    {% else %}
    <tr title="Downloaded?" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Downloaded?</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Downloaded?<br></span><strong>{% if media.downloaded %}<i class="fas fa-check text-green-600"></i>&nbsp;{{ media.download_date|date:'Y-m-d H:i:s' }}{% else %}<i class="fas fa-times text-destructive"></i>{% endif %}</strong></td>
    </tr>
    {% endif %}
    {% if media.downloaded %}
    <tr title="Filename" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Filename</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Filename<br></span><strong>{{ filename_path.name }}</strong></td>
    </tr>
    <tr title="Directory" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Directory</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Directory<br></span><strong>{{ media.directory_path }}</strong></td>
    </tr>
    <tr title="Database Filepath" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Database&nbsp;Filepath</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">DB&nbsp;Filepath<br></span><strong>{{ media_file_path }}</strong>
        {% if media_file_path == media.filepath %}
        <span class="text-green-600">&nbsp;(matched)</span>
        {% endif %}
      </td>
    </tr>
    <tr title="File size" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">File size</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">File size<br></span><strong>{{ media.downloaded_filesize|bytesformat }}</strong></td>
    </tr>
    <tr title="Downloaded codecs" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Downloaded codecs</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Downloaded codecs<br></span><strong>audio:{{ media.downloaded_audio_codec }}{% if media.downloaded_video_codec %}, video:{{ media.downloaded_video_codec }}{% endif %}</strong></td>
    </tr>
    <tr title="Container" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Container</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Container<br></span><strong>{{ media.downloaded_container|upper }}</strong></td>
    </tr>
    {% if media.downloaded_video_codec %}
    <tr title="Downloaded FPS" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Downloaded FPS</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Downloaded FPS<br></span><strong>{{ media.downloaded_fps }} FPS</strong></td>
    </tr>
    <tr title="Downloaded HDR?" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Downloaded HDR?</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Downloaded HDR?<br></span><strong>{% if media.downloaded_hdr %}<i class="fas fa-check text-green-600"></i>{% else %}<i class="fas fa-times text-destructive"></i>{% endif %}</strong></td>
    </tr>
    {% endif %}
    {% else %}
    <tr title="Can download?" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3">Can download?</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Can download?<br></span><strong>{% if media.can_download %}<i class="fas fa-check text-green-600"></i>{% else %}<i class="fas fa-times text-destructive"></i>{% endif %}</strong></td>
    </tr>
    {% endif %}
    <tr title="Available formats" class="border-b border-border">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3 align-top">Available formats</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Available formats<br></span>
        {% for format in media.iter_formats %}
        <div class="text-xs leading-relaxed">
          ID: <strong>{{ format.id }}</strong>
          {% if format.vcodec|lower != 'none' %}, {{ format.format_note }} ({{ format.width }}x{{ format.height }}), fps:{{ format.fps|lower }}, video:{{ format.vcodec }} @{{ format.vbr }}k{% endif %}
          {% if format.acodec|lower != 'none' %}, audio:{{ format.acodec }} {% if format.abr %}@{{ format.abr }}k / {% endif %}{{ format.asr|intcomma }}Hz{% if format.language_code %} [{{ format.language_code }}]{% endif %}{% if format.abr %} {{ format.format_note }}{% endif %}{% endif %}
          {% if format.id == combined_format or format.id == audio_format or format.id == video_format %}<strong class="text-green-600">(matched)</strong>{% endif %}
        </div>
        {% empty %}
        Media has no indexed available formats
        {% endfor %}
      </td>
    </tr>
    <tr title="Matched formats">
      <td class="hidden sm:table-cell py-3 px-4 text-muted-foreground font-medium w-1/3 align-top">Matched formats</td>
      <td class="py-3 px-4"><span class="sm:hidden text-muted-foreground">Matched formats<br></span>
        Combined: <strong>{% if combined_format %}{{ combined_format }}{% if combined_format_dict.language_code %} [{{ combined_format_dict.language_code }}]{% endif %} {% if combined_exact %}(exact match){% else %}(fallback){% endif %}{% else %}no match{% endif %}</strong><br>
        Audio: <strong>{% if audio_format %}{{ audio_format }}{% if audio_format_dict.language_code %} [{{ audio_format_dict.language_code }}]{% endif %} {% if audio_exact %}(exact match){% else %}(fallback){% endif %}{% else %}no match{% endif %}</strong><br>
        Video: <strong>{% if video_format %}{{ video_format }} {% if video_exact %}(exact match){% else %}(fallback){% endif %}{% else %}no match{% endif %}</strong>
      </td>
    </tr>
  </table>
</div>

<!-- Actions -->
{% if media.downloaded %}
<div class="flex flex-col sm:flex-row gap-3">
  <a href="{% url 'sync:redownload-media' pk=media.pk %}" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-md bg-primary text-primary-foreground font-medium text-sm hover:bg-accent hover:text-accent-foreground transition-colors">Redownload media <i class="fas fa-cloud-download-alt"></i></a>
  <a href="{% url 'sync:skip-media' pk=media.pk %}" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-md bg-destructive text-destructive-foreground font-medium text-sm hover:bg-destructive/80 transition-colors">Delete and skip media <i class="fas fa-times-circle"></i></a>
</div>
{% else %}
<div>
  {% if media.manual_skip %}
    <a href="{% url 'sync:enable-media' pk=media.pk %}" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-md bg-primary text-primary-foreground font-medium text-sm hover:bg-accent hover:text-accent-foreground transition-colors">Unskip media (manually) <i class="fas fa-cloud-download-alt"></i></a>
  {% else %}
    <a href="{% url 'sync:skip-media' pk=media.pk %}" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-md bg-destructive text-destructive-foreground font-medium text-sm hover:bg-destructive/80 transition-colors">Manually mark media to be skipped <i class="fas fa-times-circle"></i></a>
  {% endif %}
</div>
{% endif %}
{% endblock %}
