{% extends 'base.html' %}{% load humanize %}{% load filters %}

{% block headtitle %}Tasks{% endblock %}

{% block content %}
<h1>Tasks</h1>
<p class="text-muted-foreground mb-6">
  Tasks are the background work that TubeSync undertakes to index and download
  media. This page allows you to see basic overview of what is running and what is
  scheduled to perform in the future as well as check up on any errors that might
  have occured.
</p>

{% include 'infobox.html' with message=message %}

<!-- Running -->
<h2>{{ running|length|intcomma }} Running</h2>
<p class="text-sm text-muted-foreground mb-3">Running tasks are tasks which currently being worked on right now.</p>
<div class="divide-y divide-border rounded-lg border border-border overflow-hidden mb-6">
  {% for task in running %}
    <a href="{%if task.instance.pk %}{% url task.url pk=task.instance.pk %}{% else %}#{{ task.task_id }}{% endif %}" class="block p-4 hover:bg-muted/50 transition-colors">
      <i class="fas fa-running text-accent"></i> <strong>{{ task }}</strong><br>
      <span class="text-sm text-muted-foreground"><i class="far fa-clock"></i> Task started at <strong class="text-foreground">{{ task.start_at|date:'Y-m-d H:i:s' }}</strong></span>
    </a>
  {% empty %}
    <div class="p-4 text-muted-foreground"><i class="fas fa-info-circle"></i> There are no running tasks.</div>
    {% if wait_for_database_queue %}
    <div class="p-4 text-sm text-muted-foreground">
      No tasks are running because another task has requested a pause of the queue.<br>
      While the database tasks are still running, additional tasks will remain scheduled.
    </div>
    {% endif %}
  {% endfor %}
</div>

<!-- Errors -->
<h2>{{ total_errors|intcomma }} Total Error{{ total_errors|pluralize }} ({{ errors|length|intcomma }} on this page)</h2>
<p class="text-sm text-muted-foreground mb-3">
  Tasks which generated an error are shown here. Tasks are retried a couple of
  times, so if there was an intermittent error such as a download got interrupted
  it will be scheduled to run again.
</p>
<div class="divide-y divide-border rounded-lg border border-border overflow-hidden mb-6">
  {% for task in errors %}
    <div class="p-4">
      <a href="{%if task.instance.pk %}{% url task.url pk=task.instance.pk %}{% else %}#{{ task.task_id }}{% endif %}" class="text-destructive hover:text-destructive/80">
        <i class="fas fa-exclamation-triangle"></i> <strong>{{ task }}</strong>, attempted {{ task.attempts }} time{{ task.attempts|pluralize }}<br>
        <span class="text-sm">Error: &quot;{{ task.error_message }}&quot;</span>
      </a>
      <div class="text-sm text-muted-foreground mt-1">
        <i class="fas fa-history"></i> Task will be retried at <strong class="text-foreground">{{ task.scheduled_at|date:'Y-m-d H:i:s' }}</strong>
        <a href="{% url 'sync:run-task' pk=task.pk %}" class="text-destructive hover:text-destructive/80 ml-2" title="Retry now"><i class="fas fa-undo"></i></a>
      </div>
    </div>
  {% empty %}
    <div class="p-4 text-muted-foreground"><i class="fas fa-info-circle"></i> There are no tasks with errors on this page.</div>
  {% endfor %}
</div>

<!-- Scheduled -->
{% with adjusted=total_scheduled|sub:total_errors %}
<h2>{{ adjusted|intcomma }} Scheduled ({{ scheduled|length|intcomma }} on this page)</h2>
{% endwith %}
<p class="text-sm text-muted-foreground mb-3">
  Tasks which are scheduled to run in the future or are waiting in a queue to be
  processed. They can be waiting for an available worker to run immediately, or
  run in the future at the specified &quot;scheduled at&quot; time.
</p>
<div class="divide-y divide-border rounded-lg border border-border overflow-hidden mb-6">
  {% for task in scheduled %}
    <div class="p-4">
      <a href="{%if task.instance.pk %}{% url task.url pk=task.instance.pk %}{% else %}#{{ task.task_id }}{% endif %}">
        <i class="fas fa-hourglass-start text-primary"></i> <strong>{{ task }}</strong><br>
        {% if task.instance.is_active and 'once' not in task.verbose_name %}<span class="text-sm text-muted-foreground">Scheduled to run {{ task.instance.get_index_schedule_display|lower }}.</span><br>{% endif %}
        <span class="text-sm text-muted-foreground">Priority:&nbsp;{{ task.priority }}&nbsp;Queue:&nbsp;{{ task.queue }}</span><br>
        <span class="text-sm text-muted-foreground"><i class="far fa-clock"></i> Task will run {% if task.run_now %}<strong class="text-foreground">immediately</strong>{% else %}at <strong class="text-foreground">{{ task.scheduled_at|date:'Y-m-d H:i:s' }}</strong>{% endif %}</span>
      </a>
      <span class="inline-flex gap-2 ml-2">
        <a href="{% url 'sync:revoke-task' pk=task.pk %}" title="Stop task" class="text-destructive hover:text-destructive/80"><i class="far fa-stop-circle"></i></a>
        <a href="{% url 'sync:run-task' pk=task.pk %}" title="Run now" class="text-primary hover:text-accent"><i class="far fa-play-circle"></i></a>
      </span>
    </div>
  {% empty %}
    <div class="p-4 text-muted-foreground"><i class="fas fa-info-circle"></i> There are no scheduled tasks on this page.</div>
  {% endfor %}
</div>

{% include 'pagination.html' with filter=source.pk %}

<!-- Completed -->
<h2>Completed</h2>
<p class="text-sm text-muted-foreground mb-3">
  A record of recently completed tasks is kept for a few days. You can use the button
  below to view recent tasks which have completed successfully.
</p>
<a href="{% url 'sync:tasks-completed' %}" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-md bg-primary text-primary-foreground font-medium text-sm hover:bg-accent hover:text-accent-foreground transition-colors mb-6"><span class="hidden sm:inline">View </span>Completed tasks <i class="fas fa-check-double"></i></a>

<!-- Reset -->
<h2>Reset</h2>
<p class="text-sm text-muted-foreground mb-3">
  If you need to, you can reset and reschedule all tasks using the button below.
</p>
<a href="{% url 'sync:reset-tasks' %}" class="inline-flex items-center gap-2 px-4 py-2.5 rounded-md bg-primary text-primary-foreground font-medium text-sm hover:bg-accent hover:text-accent-foreground transition-colors">Reset tasks <i class="fas fa-history"></i></a>
{% endblock %}
